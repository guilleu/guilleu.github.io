<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validador de Etiquetas · Ranking</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --grad-a:#0ea5e9; /* sky-500 */
      --grad-b:#22c55e; /* green-500 */
      --ink:#0f172a;    /* slate-900 */
    }
    body{background:linear-gradient(120deg,var(--grad-a) 0%, var(--grad-b) 100%) fixed;}
    .glass{backdrop-filter: blur(8px); background: rgba(255,255,255,.75); border: 1px solid rgba(255,255,255,.4);}
    .brand-badge{letter-spacing:.08em}
    .drop-zone{border:2px dashed #6c757d; border-radius:1rem; padding:2rem; transition: all .2s}
    .drop-zone.drag{border-color:#0d6efd; background:#e7f1ff}
    .score-badge{font-variant-numeric: tabular-nums;}
    .table thead th{position:sticky; top:0; background:#f8fafc;}
    footer a{color:inherit}
  </style>
</head>
<body>
  <header class="container py-4">
    <div class="d-flex justify-content-between align-items-center text-white">
      <div class="d-flex align-items-center gap-3">
        <i class="bi bi-graph-up-arrow fs-2"></i>
        <div>
          <h1 class="h3 mb-0 fw-bold">Validador de <span class="brand-badge">ETIQUETAS</span></h1>
          <small class="opacity-75">Subí un CSV y obtené el % de coincidencia contra el <em>golden</em>. Se guarda un ranking local.</small>
        </div>
      </div>
      <span class="badge rounded-pill text-bg-light text-dark">Bootstrap 5</span>
    </div>
  </header>

  <main class="container pb-5">
    <div class="row g-4">
      <!-- Panel de carga y resultados -->
      <div class="col-12 col-lg-7">
        <div class="card shadow-lg glass">
          <div class="card-body p-4">
            <h2 class="h5 mb-3"><i class="bi bi-cloud-upload"></i> Subí tu archivo</h2>
            <div class="row g-3 align-items-center mb-3">
              <div class="col-sm-6">
                <label class="form-label mb-1">Nombre de equipo / modelo</label>
                <input id="teamName" type="text" class="form-control" placeholder="Ej: Grupo 4 True · v3" />
              </div>
              <div class="col-sm-6">
                <label class="form-label mb-1">Estrategia de emparejamiento</label>
                <select id="matchStrategy" class="form-select">
                  <option value="id">Por columna ID</option>
                  <option value="row">Por posición de fila</option>
                </select>
              </div>
            </div>

            <div id="dropZone" class="drop-zone text-center mb-3">
              <input id="fileInput" type="file" accept=".csv" class="d-none" />
              <p class="mb-2"><i class="bi bi-filetype-csv fs-2"></i></p>
              <p class="mb-2">Arrastrá y soltá tu <strong>CSV</strong> aquí, o <a href="#" id="browseLink">buscalo</a>.</p>
              <small class="text-muted">Se espera al menos la columna <code>Etiqueta</code> y opcionalmente <code>ID</code>.</small>
            </div>

            <div class="d-flex gap-2 mb-3">
              <button id="btnValidate" class="btn btn-primary"><i class="bi bi-check2-circle"></i> Validar coincidencia</button>
              <button id="btnDownloadDiff" class="btn btn-outline-secondary" disabled><i class="bi bi-download"></i> Descargar diferencias</button>
            </div>

            <div id="resultCard" class="alert alert-info d-none" role="alert"></div>

            <div id="details" class="d-none">
              <h3 class="h6">Resumen</h3>
              <ul class="small mb-3" id="summaryList"></ul>
              <div class="table-responsive" style="max-height: 320px;">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>ID</th>
                      <th>Predicho</th>
                      <th>Esperado</th>
                      <th>Coincide</th>
                    </tr>
                  </thead>
                  <tbody id="diffTable"></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Ranking -->
      <div class="col-12 col-lg-5">
        <div class="card shadow-lg glass">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h5 mb-0"><i class="bi bi-trophy"></i> Ranking de mejores porcentajes</h2>
              <div class="btn-group">
                <button id="btnClearRanking" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash3"></i> Limpiar</button>
                <button id="btnExportRanking" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-down"></i> Exportar</button>
              </div>
            </div>
            <p class="text-muted small">Se guarda en <code>localStorage</code> del navegador. Ordenado por % desc.</p>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Equipo / Modelo</th>
                    <th>Fecha</th>
                    <th class="text-end">% Coincidencia</th>
                  </tr>
                </thead>
                <tbody id="rankingBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="container pb-4">
    <div class="glass rounded-4 p-3 text-center small text-muted">
      Hecho con <i class="bi bi-heart-fill"></i> y Bootstrap. Funciona 100% en el cliente — ideal para GitHub Pages.
    </div>
  </footer>

  <script>
    // ======================
    // GOLDEN TRUTH EMBEBIDO
    // ======================
    // Mapa ID -> Etiqueta esperada (boolean)
    const GOLD_TRUTH = {"12130": false, "6418": false, "191": false, "13373": false, "8078": false, "5656": false, "12699": true, "5696": false, "12797": false, "12854": true, "4987": false, "12076": false, "12971": false, "12725": false, "13102": false, "10596": false, "13170": false, "3092": false, "11503": false, "9866": true, "6863": false, "11841": false, "12439": false, "2196": false, "12701": false, "11894": false, "10884": true, "11214": false, "12889": false, "12175": false, "11447": false, "11848": false, "6651": false, "12360": false, "11440": false, "13364": false, "13240": false, "12614": false, "13326": false, "12932": false, "12916": false, "10719": false, "12763": true, "13081": false, "13379": false, "13173": false, "9143": false, "13359": false, "12580": true, "11228": false, "12596": false, "12637": false, "13049": false, "11374": false, "11487": false, "11410": false, "12831": false, "12389": false, "1178": false, "13026": false, "12631": false, "13200": false, "12626": false, "8087": false, "12939": false, "13118": true, "11202": false, "11373": false, "13385": false, "11561": false, "12380": false, "12563": true, "12856": false, "10457": false, "11497": false, "13176": false, "12833": false, "11529": false, "11810": false, "12721": true, "12523": false, "11697": false, "4808": false, "12672": false, "11575": false, "13110": true, "9106": false, "13160": false, "12727": false, "11489": false, "12661": false, "4668": false, "12852": false, "11735": false, "12123": false, "11332": false, "13446": false, "1022": false, "12643": false, "10063": false, "7306": false, "12391": false, "13020": false, "9974": false, "12284": false, "12653": false, "11263": false, "12438": false, "11610": false, "10882": false, "12914": false, "7519": false, "12246": false, "12700": false, "12773": false, "12461": false, "8456": false, "12349": false, "13106": false, "12188": false, "13236": false, "12693": false, "11743": false, "13377": true, "8505": false, "12822": false, "7202": false, "10915": false, "12924": false, "10589": false, "12879": false, "9764": false, "11458": false, "9648": false, "12061": false, "11484": false, "10818": false, "2321": false, "12933": false, "12650": false, "12167": false, "11126": false, "9607": true, "12016": false, "12006": false, "12111": false, "12928": false, "13324": false, "11308": false, "9384": false, "11713": false, "8483": false, "11995": false, "11120": true, "12859": false, "11349": false, "12927": false, "12588": false, "12406": false, "12945": false, "13018": false, "12666": false, "8508": false, "10796": false, "13254": false, "12803": false, "5198": false, "12786": false, "11495": false, "12724": false, "12918": false, "10955": false, "11256": false, "12633": false, "11587": false, "12977": false, "11249": false, "8397": false, "12479": false, "12234": false, "12497": false, "12473": false, "12677": false, "12683": false, "12754": false, "11553": false, "12954": false, "13089": false, "11277": false, "11450": false, "12527": false, "11989": false, "10996": false, "10364": false, "11680": false, "6940": false, "12909": false, "11036": false, "8466": false, "11518": false, "11828": false, "11190": false, "12829": false, "12160": false, "12216": false, "11486": false, "12070": false, "12324": false, "11811": false, "13124": false, "13095": false, "11786": false, "11478": false, "13098": false, "11253": false, "11671": false, "12487": false, "10759": false, "13387": false, "12057": false, "10021": false, "12447": false, "11146": false, "12271": false, "12645": false, "12783": false, "13101": false, "12072": false, "13331": false, "11042": false, "12576": false, "12494": false, "4065": false, "12768": false, "671": false, "11849": false, "11381": false, "10078": false, "11418": false, "11909": false, "7342": false, "10639": false, "10483": false, "13358": false, "13279": false, "13093": false, "2825": false, "11793": false, "11554": false, "12603": false, "11021": true, "13058": false, "13140": true, "11206": false, "10363": false, "12615": false, "11444": false, "6508": false, "12170": false, "13027": false, "12960": false, "12548": false, "13070": false, "13078": false, "11261": false, "10992": false, "12112": false, "12607": false, "12448": false, "11927": false, "12689": false, "11936": false, "12396": false, "12896": false, "12159": false, "11929": false, "13185": false, "10939": false, "11201": false, "12008": false, "12732": false, "12498": false, "12728": false, "12952": false, "12738": false, "12710": false, "12364": false, "11620": false, "12892": false, "11846": false, "12185": false, "12143": false, "11352": false, "10713": false, "6099": false, "12229": false, "6763": false, "10077": false, "11947": false, "12608": false, "11809": false, "8754": false, "9160": false, "12797": false, "9480": false, "5669": false, "11573": false, "11017": false, "13503": false, "9204": false, "12335": false, "11935": false, "12285": false, "11376": false, "12592": false, "12287": false, "5769": false, "10304": false, "9205": false, "10080": false, "7575": false, "13040": false, "11777": false, "12415": false, "13394": false, "12714": false, "11157": false, "11123": false, "13022": false, "12176": false, "10740": false, "12756": false, "12697": false, "12306": false, "11483": false, "11667": false, "11869": false, "12660": false, "11497.1": false, "11979": false, "12863": false, "12741": false, "12190": false, "13157": false, "12792": false, "11746": false, "13128": false, "13032": false, "13044": false, "12062": false, "10736": false, "6753": false, "13117": false, "13120": false, "12868": true, "10630": false, "13042": false, "12356": false, "12154": false, "13508": false, "11481": false, "12513": false, "13048": false, "13031": false, "13376": false, "11977": false, "8414": true, "11655": false, "10872": false, "11333": false, "13007": false, "11476": false, "12935": false, "11651": false, "11826": false, "12975": false, "12676": true, "12430": false, "11924": false, "12436": false, "12132": false, "10997": false, "11218": false, "13067": false, "12678": false, "12613": false, "12199": false, "12946": false, "12484": false, "12962": false, "7573": false, "11516": false, "9234": false, "11759": false, "11254": false, "12195": false, "12252": false, "12317": false, "10986": false, "12875": false, "7594": false, "8343": false, "11030": true, "13204": false, "5415": false, "11521": false, "12956": false, "12705": false, "12744": false, "13071": false, "12557": false, "12629": false, "12418": false, "12064": false, "12292": false, "12435": false, "11502": false, "12109": false, "10785": false, "12993": true, "10967": false, "13134": false, "12149": false, "13083": false, "12301": false, "12898": false, "10637": false, "7849": false, "11078": false, "11439": false, "11830": false, "12514": false, "11282": false, "9184": false, "12172": false, "2750": false, "12414": false, "6768": false, "11549": false, "6216": false, "8047": false, "8815": false, "11731": false, "9957": false, "12644": false, "9350": false, "12533": false, "12412": false, "12980": false, "12784": false, "13178": false, "12715": false, "11195": false, "11294": false, "12585": false, "13138": false, "12005": false, "13267": false, "12840": false, "12810": false, "12305": false, "13099": false, "8640": false, "12198": false, "12036": false, "13130": false, "12047": false, "12056": false, "12054": false, "10843": false, "3267": false, "12936": false, "9030": false, "12210": false, "11406": false, "12200": false, "12442": false, "10777": false, "12716": false, "11494": false, "11602": false, "4733": false, "10632": false, "12632": false, "9206": false, "12308": false, "9813": false, "12575": false, "12564": false, "12795": false, "13029": false, "7067": false, "12319": false, "12847": false, "11168": false, "13086": false, "12338": false, "11331": false, "6714": false, "12066": false, "11770": false, "12561": false, "5818": false, "12179": false, "13266": false, "12499": false, "12476": false, "13233": false, "13008": false, "8988": false, "12906": false, "13038": false, "9503": false, "10517": false, "12821": false, "12185.1": false, "12793": false, "12789": false, "12571": false, "12270": false, "12537": false, "12265": false, "12947": false, "11667": false, "11652": false, "11071": false, "13100": false, "12887": false, "12698": false, "11910": false, "12684": false, "12124": false, "12604": false, "12212": false, "13045": false, "11183": false, "11857": false, "12394": false, "12805": false, "11145": false, "11780": false, "11015": false, "12173": false, "11402": false, "12115": false, "11217": false, "12802": false, "12510": false, "12248": false, "12237": false, "12764": false, "11388": false, "10789": false, "6841": false, "11940": false, "13012": false, "12722": false, "13001": false, "12354": false, "11193": false, "12624": false, "12559": false, "10761": false, "12131": false, "10650": false, "10210": false, "12692": false, "12654": false, "12618": false, "13398": false, "12770": false, "13017": false, "13234": false, "11297": false, "12071": false, "12116": false, "12712": false, "13137": false, "6910": false, "13030": false, "11855": false, "6706": false, "12155": false, "13265": false, "13011": false, "11062": false, "12612": false, "925": false, "7743": false, "10683": false, "12143.1": false, "12269": false, "12323": false, "12010": false, "12458": false, "13121": false, "8182": false, "13299": false, "12411": false, "12506": false, "12664": false, "8896": false, "12460": false, "11690": false, "12983": false, "12865": false, "6084": false, "11030.1": false, "13135": false, "13171": false, "12903": false, "12440": false, "13053": false, "11693": false, "7776": false, "13153": false, "13088": false, "12720": false, "12907": false, "7338": false, "12750": false, "12607.1": false, "7922": false, "12405": false, "745": false, "13164": false, "12410": false, "13000": false, "12663": false, "12138": false, "12941": false, "11751": false, "10931": false, "13163": false, "13133": false, "11510": false, "12263": false, "12969": false, "12113": false, "11913": false, "9475": false, "12662": false, "7986": false, "12068": false, "13082": false, "13161": false, "12104": false, "10776": false, "12125": false, "12694": false, "10513": false, "12392": false, "11330": false, "12122": false, "12828": false, "12196": false, "12162": false, "10951": false, "12566": false, "12679": false, "6186": false, "13041": false, "9865": false, "13105": false, "13006": false, "1167": true, "12967": false, "12224": false, "12524": false, "12600": false, "12239": false, "11714": false, "13010": false, "12073": false, "6486": false, "11803": false, "12667": false, "11344": false, "11599": false, "12474": false, "12659": false, "12687": false, "12696": false, "7765": false, "11070": false, "12691": false, "12655": false, "13132": false, "11184": false, "12762": false, "12165": false, "5445": false, "12191": false, "11527": false, "12409": false, "12192": false, "12657": false, "12423": false, "12620": false, "9403": false, "11372": false, "12177": false, "12921": false, "13072": false, "12060": false, "6431": false, "9226": false, "11269": false, "12059": false, "13156": false, "13066": false, "11412": false, "11436": false, "12377": false, "12774": false, "11275": false, "12483": false, "9142": false, "10459": false, "12021": false, "13037": false, "13076": false, "5751": false, "12140": false, "12570": false, "12912": false, "12395": false, "13162": false, "12931": false, "12407": false, "12316": false, "12267": false, "12427": false, "11290": false, "11218.1": false, "9681": false, "12148": false, "12134": false, "12522": false, "10614": false, "13167": false, "10638": false, "9617": false, "11152": false, "12450": false, "7416": false, "12128": false, "12313": false, "10081": false, "12044": false, "10991": false, "13064": false, "11397": false, "13172": false, "8759": false, "12065": false, "12974": false, "13141": false, "11160": false, "12646": false, "11204": false, "12105": false, "12970": false, "12520": false, "12178": false, "11971": false, "7272": false, "12362": false, "7047": false, "11844": false, "11198": false, "13057": false, "12690": false, "6095": false, "12511": false, "13097": false, "12142": false, "8141": false, "13155": false, "11500": false, "13158": false, "12926": false, "11831": false, "13127": false, "6051": false, "12403": false, "11908": false, "12532": false, "12621": false, "13159": false, "11601": false, "9423": false, "13235": false, "2671": false, "13126": false, "12504": false, "10308": false, "8985": false, "12462": false, "11154": false, "12161": false, "12055": false, "5923": false, "13069": false, "12519": false, "13036": false, "12531": false, "11829": false, "12547": false, "12048": false, "11305": false, "13084": false, "13085": false, "11966": false, "11227": false, "8763": false, "11368": false, "12817": false, "1653": false, "12401": false, "12813": false, "8238": false, "6223": false, "11216": false, "12144": false, "12862": false, "11153": false, "11522": false, "11825": false, "10069": false, "12610": false, "12695": false, "11075": false, "11390": false, "12622": false, "12799": false, "12118": false, "8236": false, "12938": false, "12671": false, "13050": false, "12628": false, "12137": false, "11799": false, "13131": false, "6566": false, "13013": false, "11757": false, "12119": false, "11435": false, "1021": false, "11429": false, "11885": false, "13142": false, "5928": false, "12303": false, "10504": false, "9970": false, "12583": false, "12194": false, "12163": false, "12201": false, "12331": false, "12171": false, "11266": false, "12012": false, "9785": false, "6623": false, "10659": false, "12031": false, "11646": false, "12174": false, "12738.1": false, "12965": false, "12164": false, "12408": false, "7235": false, "12241": false, "12766": false, "12542": false, "13113": false, "7936": false, "11208": false, "13151": false, "11733": false, "12419": false, "13125": false, "12193": false, "11032": false, "12091": false, "7715": false, "11853": false, "11446": false, "11723": false, "12681": false, "12963": false, "12466": false, "11541": false, "12268": false, "12545": false, "11365": false, "9904": false, "11129": false, "5690": false, "12641": false, "9661": false, "8436": false, "12966": false, "11403": false, "12553": false, "11230": false, "12336": false, "12844": false, "12755": false, "7301": false, "12929": false, "11802": false, "12327": false, "13114": false, "12472": false, "12135": false, "12029": false, "11244": false, "13123": false, "12981": false, "12451": false, "12463": false, "12226": false, "13025": false, "11185": false, "12307": false, "9241": false, "8574": false, "11110": false, "12032": false, "11130": false, "13046": false, "5468": false, "11211": false, "11827": false, "8058": false, "11960": false, "13119": false, "11083": false, "12314": false, "11311": false, "11082": false, "12244": false, "11579": false, "7949": false, "12019": false, "11406.1": false, "13107": false, "12431": false, "12151": false, "12872": false, "12351": false, "13080": false, "12337": false, "12902": false, "12129": false, "11298": false, "11986": false, "7826": false, "12186": false, "12706": false, "10959": false, "12581": false, "12321": false, "12984": false, "12288": false, "11472": false, "12955": false, "12190.1": false, "12043": false, "13115": false, "6991": false, "13168": false, "13165": false, "12901": false, "10912": false, "11867": false, "12232": false, "12207": false, "12139": false, "12107": false, "11866": false, "9100": false, "12051": false, "12208": false, "12240": false, "11383": false, "12000": false, "12038": false, "13096": false, "12627": false, "13154": false, "12090": false, "12885": false, "13052": false, "12199.1": false, "12014": false, "12478": false, "12082": false, "12708": false, "10865": false, "13111": false, "12130.1": false, "11226": false, "10745": false, "12184": false, "12886": false, "12180": false, "9138": false, "11748": false, "13112": false, "13201": false, "9242": false, "12922": false, "12560": false, "13122": false, "13009": false, "5927": false, "12117": false, "11669": false, "13047": false, "11962": false, "11758": false, "13143": false, "11318": false, "12446": false, "11595": false, "12004": false, "13087": false, "12035": false, "12189": false, "13051": false, "12711": false, "12126": false, "12221": false, "13141.1": false, "12106": false, "12477": false, "13136": false, "11295": false, "12707": false, "12251": false, "12183": false, "12158": false, "12136": false, "12187": false, "12686": false, "13073": false, "11118": false, "12330": false, "11200": false, "13129": false, "10857": false, "12121": false, "11764": false, "12540": false, "12033": false, "7347": false, "12166": false, "5924": false, "12141": false, "12437": false, "12231": false, "12647": false, "12492": false, "12039": false, "13074": false, "12611": false, "11845": false, "7692": false, "12752": false, "12488": false, "12787": false, "9721": false, "12024": false, "13156.1": false, "11414": false, "12156": false, "13144": false, "8175": false, "11392": false, "12416": false, "10899": false, "12279": false, "12174.1": false, "7695": false, "11852": false, "6459": false, "12953": false, "12370": false, "12145": false, "11572": false, "12623": false, "13147": false, "12182": false, "12077": false, "12567": false, "13138.1": false, "12097": false, "12181": false, "12011": false, "10784": false, "12424": false, "13063": false, "10972": false, "13019": false, "12067": false, "11511": false, "12562": false, "11000": false, "11778": false, "11941": false, "13039": false, "12765": false, "11259": false, "12930": false, "11871": false, "12425": false, "5698": false, "8682": false, "12141.1": false, "8021": false, "12230": false, "12092": false, "11703": false, "6829": false, "12649": false, "12108": false, "13092": false, "12098": false, "13091": false, "13152": false, "3370": false, "11701": false, "10591": false, "11712": false, "11864": false, "13133.1": false, "9983": false, "12103": false, "13103": false, "11820": false, "12864": false, "11605": false, "11191": false, "12063": false, "11151": false, "12152": false, "12485": false, "12110": false, "12215": false, "11911": false, "9765": false, "12426": false, "13139": false, "12023": false, "12100": false, "12556": false, "10757": false, "12228": false, "12311": false, "13077": false, "12114": true, "13003": false, "12083": false, "12550": false, "11273": false, "12050": false, "13016": false, "12053": false, "11504": false, "12101": false, "9960": false, "12211": false, "12652": false, "7280": false, "9011": false, "13207": false, "3552": false, "12080": false, "12049": false, "8818": false, "10794": false, "12217": false, "12652.1": false, "11367": false, "7881": false, "12507": false, "13059": false, "13220": false, "11938": false, "11262": false, "13090": false, "9954": false, "11182": false, "11177": false, "12203": false, "12606": false, "11013": false, "6540": false, "13043": false, "11959": false, "12702": false, "12518": false, "11480": false, "11870": false, "12042": false, "5906": false, "10892": false, "12088": false, "11019": false, "11002": false, "11258": false, "13087.1": false, "12796": false, "11345": false, "12848": false, "12266": false, "9955": false, "12020": false, "12751": false, "10101": false, "5860": false, "12298": false, "10636": false, "13150": false, "13024": false, "12133": false, "12120": false, "12429": false, "10002": false, "12373": false, "12037": false, "12486": false, "12197": false, "10666": false, "12157": false, "5608": false, "11003": false, "10701": false, "13166": false, "12184.1": false, "12146": false, "10607": false, "13227": false, "12025": false, "12278": false, "13028": false, "12801": false, "8452": false, "12272": false, "4780": false, "12150": false, "12144.1": false, "11661": false, "13014": false, "11832": false, "12147": false, "12027": false, "12917": false, "12168": false, "12286": false, "8738": false, "11776": false, "12459": false, "13149": false, "11430": false, "11945": false, "13094": false, "12529": false, "12040": false, "11255": false, "12132.1": false, "12590": false, "12353": false, "13410": false, "11224": false, "12718": false, "12153": false, "13062": false, "12310": false, "13109": false, "11597": false, "12167.1": false, "12119.1": false, "12469": false, "12187.1": false, "11423": false, "10185": false, "13061": false, "11787": false, "12152.1": false, "10535": false, "12137.1": false, "12126.1": false, "11792": false, "12164.1": false, "12174": false, "12103.1": false, "12177.1": false, "12120.1": false, "12165.1": false, "12163.1": false, "12125.1": false, "12127": false, "12145.1": false, "12131.1": false, "12198.1": false, "12168.1": false, "12149.1": false, "12146.1": false, "12148.1": false, "12161.1": false, "12162.1": false, "12150.1": false, "6240": true, "11357": false, "11448": false, "13056": false, "11968": false, "12122.1": false, "5195": false, "12269.1": false, "12157.1": false, "12159.1": false, "12117.1": false, "12169": false, "12158.1": false, "12107.1": false, "12160.1": false, "12172.1": false, "12143": false, "12156.1": false, "12144": false, "12118.1": false, "12155.1": false, "12142.1": false, "12141.2": false, "12152.2": false, "12153.1": false, "12140.1": false, "12139.1": false, "12138.1": false, "12136.1": false, "12135.1": false, "12134.1": false, "12133.1": false, "12132.2": false, "12130.2": false, "12129.1": false, "12128.1": false, "12127.1": false, "12129": false, "12124.1": false, "12123.1": false, "12121.1": false, "12116.1": false, "12115.1": false, "12114.1": false, "12113.1": false, "12112.1": false, "12111.1": false, "12110": false, "6581": true, "7482": true, "4842": true, "8414.1": true, "9982": true, "201": true, "10968": true}
  </script>
  <script>
    // Reemplazamos GOLD_TRUTH con el objeto preinyectado desde el backend de ChatGPT (a continuación)
  </script>
  <script>
    // Parche de GOLD_TRUTH para IDs mal embebidos (override)
    const GOLD_PATCH = {"11495":true,"5860":true,"12000":true,"13057":true,"13207":true,"12796":true,"12755":true,"12048":true,"12111":true,"12692":true,"12801":true,"12125":true};
    Object.assign(GOLD_TRUTH, GOLD_PATCH);
  </script>
  <script>
    // ======================
    // UTILIDADES
    // ======================
    const LS_KEY = 'rankingEtiquetas_v1';

    function parseCSV(text){
      // Sencillo parser CSV: separa por líneas y comas, maneja comillas dobles básicas
      // Para casos complejos, se podría integrar PapaParse, pero evitamos dependencias.
      const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
      const header = splitCSVLine(lines[0]);
      const rows = lines.slice(1).map(line => {
        const cols = splitCSVLine(line);
        const obj = {};
        header.forEach((h,i)=> obj[h.trim()] = (cols[i]??'').trim());
        return obj;
      });
      return { header, rows };
    }
    function splitCSVLine(line){
      const out = []; let cur = ''; let q = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch==='"'){
          if(q && line[i+1]==='"'){ cur+='"'; i++; }
          else { q=!q; }
        } else if(ch===',' && !q){ out.push(cur); cur=''; }
        else { cur+=ch; }
      }
      out.push(cur);
      return out;
    }
    function toBool(v){
      if(typeof v === 'boolean') return v;
      const s = String(v).trim().toLowerCase();
      return s==='true' || s==='1' || s==='t' || s==='yes' || s==='si' || s==='sí';
    }
    function normalizeId(v){
      const s = String(v ?? '').trim();
      const n = Number(s);
      if(Number.isFinite(n) && Number.isInteger(n)) return String(n);
      return s;
    }
    function fmtPct(p){ return (p*100).toFixed(2)+'%'; }
    function todayISO(){ return new Date().toLocaleString(); }

    // ======================
    // UI ELEMENTOS
    // ======================
    const dz = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const browseLink = document.getElementById('browseLink');
    const btnValidate = document.getElementById('btnValidate');
    const btnDownloadDiff = document.getElementById('btnDownloadDiff');
    const resultCard = document.getElementById('resultCard');
    const summaryList = document.getElementById('summaryList');
    const diffTable = document.getElementById('diffTable');
    const details = document.getElementById('details');
    const rankingBody = document.getElementById('rankingBody');
    const teamNameInput = document.getElementById('teamName');
    const matchStrategy = document.getElementById('matchStrategy');

    // Drag & drop
    ;['dragenter','dragover'].forEach(evt=> dz.addEventListener(evt, e=>{e.preventDefault(); dz.classList.add('drag')}));
    ;['dragleave','drop'].forEach(evt=> dz.addEventListener(evt, e=>{e.preventDefault(); dz.classList.remove('drag')}));
    dz.addEventListener('drop', e=>{
      const f = e.dataTransfer.files?.[0];
      if(f) fileInput.files = e.dataTransfer.files;
    });
    browseLink.addEventListener('click', e=>{ e.preventDefault(); fileInput.click(); });

    // ======================
    // VALIDACIÓN PRINCIPAL
    // ======================
    let lastDiff = [];

    btnValidate.addEventListener('click', async ()=>{
      const file = fileInput.files?.[0];
      if(!file){
        alert('Primero seleccioná un archivo CSV.');
        return;
      }
      const team = teamNameInput.value.trim() || 'Anónimo';
      const text = await file.text();
      const {header, rows} = parseCSV(text);

      // Normalizamos nombres de columnas (match flexible)
      const colsLower = header.map(h=>h.toLowerCase());
      const hasId = colsLower.includes('id');
      const labelIdx = colsLower.indexOf('etiqueta');
      if(labelIdx===-1){
        alert('Tu CSV debe contener la columna "Etiqueta".');
        return;
      }

      // Construimos arrays comparables: (id, predLabel, goldLabel)
      let comparable = [];
      if(matchStrategy.value==='id' && hasId){
        for(const r of rows){
          const id = normalizeId(r[header[colsLower.indexOf('id')]]);
          if(!id) continue;
          const pred = toBool(r[header[labelIdx]]);
          const gold = GOLD_TRUTH[id];
          if(typeof gold === 'boolean'){
            comparable.push({id, pred, gold});
          }
        }
      } else {
        // Por posición de fila (sin cabecera)
        const goldEntries = Object.entries(GOLD_TRUTH);
        const n = Math.min(rows.length, goldEntries.length);
        for(let i=0;i<n;i++){
          const id = goldEntries[i][0];
          const gold = goldEntries[i][1];
          const pred = toBool(rows[i][header[labelIdx]]);
          comparable.push({id, pred, gold});
        }
      }

      if(comparable.length===0){
        alert('No se encontraron filas comparables. Verificá que exista la columna ID o usá la opción por posición.');
        return;
      }

      const matches = comparable.filter(r=> r.pred === r.gold).length;
      const pct = matches / comparable.length;

      // UI resultado
      resultCard.classList.remove('d-none','alert-danger','alert-info');
      resultCard.classList.add('alert-info');
      resultCard.innerHTML = `<strong>Resultado:</strong> Coincidencias ${matches} / ${comparable.length} ⇒ <span class="badge text-bg-primary score-badge">${fmtPct(pct)}</span>`;

      // Detalle & tabla diff
      lastDiff = comparable.map((r,i)=> ({idx:i+1, ...r, ok:(r.pred===r.gold)}));
      details.classList.remove('d-none');
      summaryList.innerHTML = `
        <li>Total comparable: <code>${comparable.length}</code></li>
        <li>Acertadas: <code>${matches}</code></li>
        <li>Porcentaje: <span class="badge text-bg-success">${fmtPct(pct)}</span></li>
        <li>Estrategia: <code>${matchStrategy.value}</code></li>
      `;
      diffTable.innerHTML = lastDiff.map(r=> `
        <tr class="${r.ok? 'table-success' : 'table-danger'}">
          <td>${r.idx}</td>
          <td>${r.id}</td>
          <td>${r.pred}</td>
          <td>${r.gold}</td>
          <td>${r.ok? '<i class="bi bi-check2"></i>' : '<i class="bi bi-x-lg"></i>'}</td>
        </tr>`).join('');

      // Ranking (localStorage)
      const entry = { team, pct: +(pct*100).toFixed(4), date: todayISO() };
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      arr.push(entry);
      arr.sort((a,b)=> b.pct - a.pct);
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
      renderRanking();

      // Habilitar descarga de diferencias
      btnDownloadDiff.disabled = false;
    });

    btnDownloadDiff.addEventListener('click', ()=>{
      if(!lastDiff?.length) return;
      const header = ['idx','ID','Predicho','Esperado','Coincide'];
      const lines = [header.join(',')].concat(
        lastDiff.map(r=> [r.idx, r.id, r.pred, r.gold, r.ok].join(','))
      );
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'diferencias.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    function renderRanking(){
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      rankingBody.innerHTML = arr.map((r,i)=> `
        <tr>
          <td>${i+1}</td>
          <td>${r.team}</td>
          <td><span class="small text-muted">${r.date}</span></td>
          <td class="text-end fw-semibold">${r.pct.toFixed(2)}%</td>
        </tr>
      `).join('');
    }

    document.getElementById('btnClearRanking').addEventListener('click', ()=>{
      if(confirm('¿Eliminar el ranking guardado en este navegador?')){
        localStorage.removeItem(LS_KEY);
        renderRanking();
      }
    });
    document.getElementById('btnExportRanking').addEventListener('click', ()=>{
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      const header = ['pos','equipo','fecha','porcentaje'];
      const lines = [header.join(',')].concat(arr.map((r,i)=> [i+1, r.team, r.date, r.pct].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ranking.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // Inicial
    renderRanking();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- INYECCIÓN DEL GOLDEN (al final para mantener el HTML legible) -->
  <script>// (Gold embebido ya definido arriba en const GOLD_TRUTH)</script>
</body>
</html>
