<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validador de Etiquetas ¬∑ Ranking</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{ --grad-a:#0ea5e9; --grad-b:#22c55e; --ink:#0f172a; }
    body{background:linear-gradient(120deg,var(--grad-a) 0%, var(--grad-b) 100%) fixed;}
    .glass{backdrop-filter: blur(8px); background: rgba(255,255,255,.75); border: 1px solid rgba(255,255,255,.4);}
    .brand-badge{letter-spacing:.08em}
    .drop-zone{border:2px dashed #6c757d; border-radius:1rem; padding:2rem; transition: all .2s}
    .drop-zone.drag{border-color:#0d6efd; background:#e7f1ff}
    .score-badge{font-variant-numeric: tabular-nums;}
    footer a{color:inherit}
  </style>
</head>
<body>
  <header class="container py-4">
    <div class="d-flex justify-content-between align-items-center text-white">
      <div class="d-flex align-items-center gap-3">
        <i class="bi bi-graph-up-arrow fs-2"></i>
        <div>
          <h1 class="h3 mb-0 fw-bold">Validador de <span class="brand-badge">ETIQUETAS</span></h1>
          <small class="opacity-75">Sub√≠ un CSV y obten√© el % de coincidencia. Se guarda un ranking local y (opcional) en Firebase.</small>
        </div>
      </div>
      <span class="badge rounded-pill text-bg-light text-dark">Bootstrap 5</span>
    </div>
  </header>

  <main class="container pb-5">
    <div class="row g-4">
      <!-- Panel de carga y resultado -->
      <div class="col-12 col-lg-7">
        <div class="card shadow-lg glass">
          <div class="card-body p-4">
            <h2 class="h5 mb-3"><i class="bi bi-cloud-upload"></i> Sub√≠ tu archivo</h2>

            <div class="row g-3 align-items-center mb-3">
              <div class="col-sm-12">
                <label class="form-label mb-1">Nombre de equipo / modelo</label>
                <input id="teamName" type="text" class="form-control" placeholder="Ej: Grupo 4 True ¬∑ v3" />
              </div>
            </div>

            <div id="dropZone" class="drop-zone text-center mb-3">
              <input id="fileInput" type="file" accept=".csv" class="d-none" />
              <p class="mb-2"><i class="bi bi-filetype-csv fs-2"></i></p>
              <p class="mb-2">Arrastr√° y solt√° tu <strong>CSV</strong> aqu√≠, o <a href="#" id="browseLink">buscalo</a>.</p>
              <small class="text-muted">Se requieren las columnas <code>ID</code> y <code>Etiqueta</code>.</small>
            </div>

            <div class="d-flex gap-2 mb-3">
              <button id="btnValidate" class="btn btn-primary"><i class="bi bi-check2-circle"></i> Validar coincidencia</button>
            </div>

            <div id="resultCard" class="alert alert-info d-none" role="alert"></div>
          </div>
        </div>
      </div>

      <!-- Ranking -->
      <div class="col-12 col-lg-5">
        <div class="card shadow-lg glass">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h5 mb-0"><i class="bi bi-trophy"></i> Ranking de mejores porcentajes</h2>
              <div class="btn-group">
                <button id="btnClearRanking" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash3"></i> Limpiar</button>
                <button id="btnExportRanking" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-down"></i> Exportar</button>
              </div>
            </div>
            <p class="text-muted small">Se guarda en <code>localStorage</code> (y en Firebase si est√° disponible). Ordenado por % desc.</p>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Equipo / Modelo</th>
                    <th>Fecha</th>
                    <th class="text-end">% Coincidencia</th>
                  </tr>
                </thead>
                <tbody id="rankingBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer class="container pb-4">
    <div class="glass rounded-4 p-3 text-center small text-muted">
      CERP del Litoral Salto - Profesorado de Inform√°tica - Prof. Guillermo Uscudum
    </div>
  </footer>

  <!-- ======================
       DATOS ESPERADOS EMBEBIDOS
       ====================== -->
  <script>
    /* üëá Peg√° aqu√≠ tu objeto GOLD_TRUTH COMPLETO (sin recortar): */
    const GOLD_TRUTH = {/* Pegar aqu√≠ el mapa ID->boolean tal como lo ten√©s */};

    /* Overrides confirmados (IDs que deben ser true) */
    const GOLD_PATCH = {
      "13118": true,"11120": true,"12114": true,"11021": true,"1812": true,"12993": true,
      "7137": true,"8885": true,"12580": true,"12755": true,"12796": true,"13207": true,
      "13057": true,"12692": true,"12048": true,"12111": true,"11495": true,"5860": true,
      "12000": true,"12801": true,"12125": true,"12676": true,"12868": true,"13110": true,
      "13140": true,"11030": true,"1167":  true,"12721": true,
      "12563": true, "11634": true
    };
  </script>

  <script>
    /* ======================
       UTILIDADES Y L√ìGICA
       ====================== */
    const LS_KEY = 'rankingEtiquetas_v1';

    function parseCSV(text){
      const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
      const header = splitCSVLine(lines[0]);
      const rows = lines.slice(1).map(line => {
        const cols = splitCSVLine(line);
        const obj = {};
        header.forEach((h,i)=> obj[h.trim()] = (cols[i]??'').trim());
        return obj;
      });
      return { header, rows };
    }
    function splitCSVLine(line){
      const out = []; let cur = ''; let q = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch==='"'){
          if(q && line[i+1]==='"'){ cur+='"'; i++; }
          else { q=!q; }
        } else if(ch===',' && !q){ out.push(cur); cur=''; }
        else { cur+=ch; }
      }
      out.push(cur);
      return out;
    }
    function toBool(v){
      if(typeof v === 'boolean') return v;
      const s = String(v).trim().toLowerCase();
      return s==='true' || s==='1' || s==='t' || s==='yes' || s==='si' || s==='s√≠';
    }
    function fmtPct(p){ return (p*100).toFixed(2)+'%'; }
    function todayISO(){ return new Date().toLocaleString(); }
    function normalizeId(v){
      const s = String(v ?? '').trim();
      if(/^\d+(?:\.0+)?$/.test(s)) return String(parseInt(Number(s),10)); // 1234.0 ‚Üí "1234"
      return s;
    }
    function rebuildGold(baseMap, patch){
      const out = {};
      for(const [k,v] of Object.entries(baseMap||{})){
        const id = normalizeId(k);
        if(!id) continue;
        out[id] = !!v;
      }
      for(const [k,v] of Object.entries(patch||{})){
        const id = normalizeId(k);
        out[id] = !!v;
      }
      return out;
    }

    // ===== UI =====
    const dz = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const browseLink = document.getElementById('browseLink');
    const btnValidate = document.getElementById('btnValidate');
    const resultCard = document.getElementById('resultCard');
    const rankingBody = document.getElementById('rankingBody');
    const teamNameInput = document.getElementById('teamName');

    // Drag & drop
    ;['dragenter','dragover'].forEach(evt=> dz.addEventListener(evt, e=>{e.preventDefault(); dz.classList.add('drag')}));
    ;['dragleave','drop'].forEach(evt=> dz.addEventListener(evt, e=>{e.preventDefault(); dz.classList.remove('drag')}));
    dz.addEventListener('drop', e=>{
      const f = e.dataTransfer.files?.[0];
      if(f) fileInput.files = e.dataTransfer.files;
    });
    browseLink.addEventListener('click', e=>{ e.preventDefault(); fileInput.click(); });

    // ===== RANKING render (üî• para el top 1) =====
    function renderRankingFromArray(arr){
      rankingBody.innerHTML = arr.map((r,i)=> {
        const pos = i + 1;
        const labelTeam = (i===0 ? 'üî• ' : '') + r.team;
        return `
          <tr>
            <td>${pos}</td>
            <td>${labelTeam}</td>
            <td><span class="small text-muted">${r.date ?? ''}</span></td>
            <td class="text-end fw-semibold">${(+r.pct).toFixed(2)}%</td>
          </tr>
        `;
      }).join('');
    }
    function renderRankingLocal(){
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      renderRankingFromArray(arr);
    }
    window.renderRankingFromArray = renderRankingFromArray; // para el m√≥dulo Firebase

    // ===== Validaci√≥n (siempre por columna ID) =====
    btnValidate.addEventListener('click', async ()=>{
      const file = fileInput.files?.[0];
      if(!file){ alert('Primero seleccion√° un archivo CSV.'); return; }

      const team = teamNameInput.value.trim() || 'An√≥nimo';
      const text = await file.text();
      const {header, rows} = parseCSV(text);

      const colsLower = header.map(h=>h.toLowerCase());
      const idIdx = colsLower.indexOf('id');
      const labelIdx = colsLower.indexOf('etiqueta');
      if(idIdx===-1 || labelIdx===-1){
        alert('Tu CSV debe contener las columnas "ID" y "Etiqueta".');
        return;
      }

      const GOLD = rebuildGold(GOLD_TRUTH, GOLD_PATCH);

      let comparable = [];
      for(const r of rows){
        const id = normalizeId(r[header[idIdx]]);
        if(!id) continue;
        const pred = toBool(r[header[labelIdx]]);
        const gold = GOLD[id];
        if(typeof gold === 'boolean'){
          comparable.push({pred, gold});
        }
      }

      if(comparable.length===0){
        alert('No se encontraron filas comparables. Verific√° los valores de ID y Etiqueta.');
        return;
      }

      const matches = comparable.filter(r=> r.pred === r.gold).length;
      const pct = matches / comparable.length;

      // Resultado
      resultCard.classList.remove('d-none','alert-danger','alert-info');
      resultCard.classList.add('alert-info');
      resultCard.innerHTML = `<strong>Resultado:</strong> Coincidencias ${matches} / ${comparable.length} ‚áí <span class="badge text-bg-primary score-badge">${fmtPct(pct)}</span>`;

      // Ranking local
      const entry = { team, pct: +(pct*100).toFixed(4), date: todayISO() };
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      arr.push(entry);
      arr.sort((a,b)=> b.pct - a.pct);
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
      renderRankingLocal();

      // Ranking remoto (si Firebase est√° listo)
      if (window.saveRankingToRTDB) {
        window.saveRankingToRTDB(entry);
      }
    });

    // Controles ranking local
    document.getElementById('btnClearRanking').addEventListener('click', ()=>{
      if(confirm('¬øEliminar el ranking guardado en este navegador?')){
        localStorage.removeItem(LS_KEY);
        renderRankingLocal();
      }
    });
    document.getElementById('btnExportRanking').addEventListener('click', ()=>{
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      const header = ['pos','equipo','fecha','porcentaje'];
      const lines = [header.join(',')].concat(arr.map((r,i)=> [i+1, r.team, r.date, r.pct].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ranking.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // Inicial: ranking local (si Firebase lee, lo reemplaza)
    renderRankingLocal();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase (Realtime Database) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getDatabase, ref, push,
      query, orderByChild, limitToFirst, onValue
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASCCPS-7ztsele9pUk8cxlD8dDRWVwH5o",
      authDomain: "machinelearning-a0c98.firebaseapp.com",
      databaseURL: "https://machinelearning-a0c98-default-rtdb.firebaseio.com",
      projectId: "machinelearning-a0c98",
      storageBucket: "machinelearning-a0c98.firebasestorage.app",
      messagingSenderId: "672139827805",
      appId: "1:672139827805:web:80ab4efd5bc59fc0b60bb4"
    };

    let db;
    try{
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      await signInAnonymously(auth);  // Activ√° "Anonymous" en Authentication
      db = getDatabase(app);
      console.log("Firebase listo (auth an√≥nima OK)");
    }catch(e){
      console.warn("Firebase no inicializado (segu√≠s con localStorage).", e);
    }

    // Guardar ranking en RTDB con manejo de errores visible
    window.saveRankingToRTDB = async function(entry) {
      if (!db) return;
      const payload = {
        team: entry.team,
        pct: entry.pct,
        date: entry.date,
        createdAt: Date.now(),
        negPct: -entry.pct
      };
      try {
        await push(ref(db, "rankings"), payload);
        console.log("RTDB: guardado", payload);
      } catch (e) {
        console.error("RTDB WRITE ERROR:", e);
        alert("‚ùå No se pudo guardar en Firebase. Revis√° Rules y Auth Anonymous. Detalle: " + (e.code || e.message));
      }
    };

    // Escuchar SIEMPRE el ranking remoto (reemplaza la tabla aunque est√© vac√≠o)
    if (db) {
      const q = query(ref(db, "rankings"), orderByChild("negPct"), limitToFirst(100));
      onValue(q, (snap) => {
        const arr = [];
        snap.forEach(child => arr.push(child.val())); // orden desc por negPct
        window.renderRankingFromArray(arr);
      }, (err) => {
        console.error("RTDB READ ERROR:", err);
        alert("‚ùå No se pudo leer de Firebase. Detalle: " + (err.code || err.message));
      });
    }
  </script>
</body>
</html>
